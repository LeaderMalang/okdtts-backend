upstream presale_testnet_upstream {
    server presale_testnet:4173;
}

upstream presale_stg_upstream {
    server presale_stg:4174;
}

upstream presale_prod_upstream {
    server presale_prod:4175;
}

upstream landing_dev_upstream {
    server landing_dev:4176;
}

upstream landing_prod_upstream {
    server landing_prod:4177;
}


upstream troy_backend_upstream {
    server troy_backend:4000;   # container name from docker-compose
}
########## HTTP â†’ HTTPS redirects ##########

server {
    listen 80;
    server_name presale.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name presale-stg.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name presale-testnet.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name troyvest.io dev.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name backend.troyvest.io;
    return 301 https://$host$request_uri;
}

########## HTTPS PROD ##########
server {
    listen 443 ssl;
    server_name presale.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/presale.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/presale.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://presale_prod_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

########## HTTPS STAGING ##########
server {
    listen 443 ssl;
    server_name presale-stg.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/presale.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/presale.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://presale_stg_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

########## HTTPS TESTNET ##########
server {
    listen 443 ssl;
    server_name presale-testnet.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/presale.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/presale.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://presale_testnet_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}


# PROD landing
server {
    listen 443 ssl;
    server_name troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/troyvest.io/privkey.pem;

    location / {
        proxy_pass http://landing_prod_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}



# DEV landing
server {
    listen 443 ssl;
    server_name dev.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/troyvest.io/privkey.pem;

    location / {
        proxy_pass http://landing_dev_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}


# PROD backend
server {
    listen 443 ssl;
    server_name backend.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/backend.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/backend.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://troy_backend_upstream;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Allow long POST requests (MaxelPay webhook)
        client_max_body_size 10M;

        # WebSockets & keepalive (good for Node apps)
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Timeout safety (blockchain calls sometimes slow)
        proxy_read_timeout 300;
        proxy_connect_timeout 60;
    }
}
