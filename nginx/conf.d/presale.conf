upstream presale_testnet_upstream {
    server presale_testnet:4173;
}

upstream presale_stg_upstream {
    server presale_stg:4174;
}

upstream presale_prod_upstream {
    server presale_prod:4175;
}

upstream landing_dev_upstream {
    server landing_dev:4176;
}

upstream landing_prod_upstream {
    server landing_prod:4177;
}

upstream admin_prod_upstream {
    server admin_prod:4178;
}


upstream troy_backend_upstream {
    server troy_backend:4000;   # container name from docker-compose
}

upstream chatwoot_upstream {
    server chatwoot:3000;
}


upstream oinic_upstream {
    server oinic_app:80;
}

########## HTTP â†’ HTTPS redirects ##########

server {
    listen 80;
    server_name presale.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name presale-stg.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name presale-testnet.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name troyvest.io dev.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name backend.troyvest.io;
    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name admin.troyvest.io;
    return 301 https://$host$request_uri;
}


server {
    listen 80;
    server_name oinic.health www.oinic.health;

    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    return 301 https://$host$request_uri;
}
########## HTTPS PROD ##########
server {
    listen 443 ssl;
    server_name presale.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/presale.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/presale.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://presale_prod_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

########## HTTPS STAGING ##########
server {
    listen 443 ssl;
    server_name presale-stg.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/presale.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/presale.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://presale_stg_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

########## HTTPS TESTNET ##########
server {
    listen 443 ssl;
    server_name presale-testnet.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/presale.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/presale.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://presale_testnet_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}


# PROD landing
server {
    listen 443 ssl;
    server_name troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/troyvest.io/privkey.pem;

    location / {
        proxy_pass http://landing_prod_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}



# DEV landing
server {
    listen 443 ssl;
    server_name dev.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/troyvest.io/privkey.pem;

    location / {
        proxy_pass http://landing_dev_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}


# PROD backend
server {
    listen 443 ssl;
    server_name backend.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/backend.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/backend.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://troy_backend_upstream;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Allow long POST requests (MaxelPay webhook)
        client_max_body_size 10M;

        # WebSockets & keepalive (good for Node apps)
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Timeout safety (blockchain calls sometimes slow)
        proxy_read_timeout 300;
        proxy_connect_timeout 60;
    }
}


# PROD admin hub
server {
    listen 443 ssl;
    server_name admin.troyvest.io;

    ssl_certificate     /etc/letsencrypt/live/admin.troyvest.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.troyvest.io/privkey.pem;

    location / {
        proxy_pass http://admin_prod_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}


# Chatwoot 

server {
    listen 80;
    server_name chatwoot.blbdev.com;
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name chatwoot.blbdev.com;

    ssl_certificate     /etc/letsencrypt/live/chatwoot.blbdev.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chatwoot.blbdev.com/privkey.pem;

    location / {
        proxy_pass http://chatwoot_upstream;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        client_max_body_size 20M;
        proxy_read_timeout 300;
        proxy_connect_timeout 60;
    }
}



# server {
#     listen 443 ssl;
#     server_name oinic.health www.oinic.health;

#     ssl_certificate     /etc/letsencrypt/live/oinic.health/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/oinic.health/privkey.pem;

#     # Optional but safe: keep challenge location here too
#     location ^~ /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#         try_files $uri =404;
#     }

#     location / {
#         proxy_pass http://oinic_upstream;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
